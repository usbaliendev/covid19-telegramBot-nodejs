const { Composer } = require("micro-bot");
const axios = require("axios");

const bot = new Composer();

/* INICIO */
bot.start((ctx) =>
	ctx.telegram.sendMessage(
		ctx.chat.id,
		`*BOT INICIADO!* ü¶†üò∑
	
üëãüèª Ol√°! Bem vindo ao seu parceiro informativo de Covid-19 do DF!
‚¨áÔ∏è Selecione a a√ß√£o desejada:
		 
1Ô∏è‚É£ - Locais e postos de vacina√ß√£o
2Ô∏è‚É£ - M√°scaras recomendadas
3Ô∏è‚É£ - Cuidados e profilaxia
4Ô∏è‚É£ - Taxa de efic√°cia das vacinas
5Ô∏è‚É£ - Tempo de intervalo entre doses
6Ô∏è‚É£ - Link de redirecionamento
(agendamento, cadastro, consulta e imprimir)
7Ô∏è‚É£ - Como a vacina funciona
8Ô∏è‚É£ - Terceira dose
9Ô∏è‚É£ - A vacina contra a nova variante`,
		{
			parse_mode: "Markdown",
			reply_markup: {
				inline_keyboard: [
					[
						{ text: "1Ô∏è‚É£", callback_data: "LPV" },
						{ text: "2Ô∏è‚É£", callback_data: "MR" },
						{ text: "3Ô∏è‚É£", callback_data: "CP" },
					],
					[
						{ text: "4Ô∏è‚É£", callback_data: "TEV" },
						{ text: "5Ô∏è‚É£", callback_data: "TIDS" },
						{ text: "6Ô∏è‚É£", callback_data: "LR" },
					],
					[
						{ text: "7Ô∏è‚É£", callback_data: "CFV" },
						{ text: "8Ô∏è‚É£", callback_data: "TD" },
						{ text: "9Ô∏è‚É£", callback_data: "VCNV" },
					],
					[{ text: "üõë Terminar", callback_data: "END" }],
				],
			},
		}
	)
);

/* REINICIAR */
bot.action("restart", (ctx) => {
	/* ctx.deleteMessage() */
	ctx.telegram.sendMessage(
		ctx.chat.id,
		`*BOT INICIADO!* ü¶†üò∑
	
üëãüèª Ol√°! Bem vindo ao seu parceiro informativo de Covid-19 do DF!
‚¨áÔ∏è Selecione a a√ß√£o desejada:
			 
1Ô∏è‚É£ - Locais e postos de vacina√ß√£o
2Ô∏è‚É£ - M√°scaras recomendadas
3Ô∏è‚É£ - Cuidados e profilaxia
4Ô∏è‚É£ - Taxa de efic√°cia das vacinas
5Ô∏è‚É£ - Tempo de intervalo entre doses
6Ô∏è‚É£ - Link de redirecionamento
(agendamento, cadastro, consulta e imprimir)
7Ô∏è‚É£ - Como a vacina funciona
8Ô∏è‚É£ - Terceira dose
9Ô∏è‚É£ - A vacina contra a nova variante`,
		{
			parse_mode: "Markdown",
			reply_markup: {
				inline_keyboard: [
					[
						{ text: "1Ô∏è‚É£", callback_data: "LPV" },
						{ text: "2Ô∏è‚É£", callback_data: "MR" },
						{ text: "3Ô∏è‚É£", callback_data: "CP" },
					],
					[
						{ text: "4Ô∏è‚É£", callback_data: "TEV" },
						{ text: "5Ô∏è‚É£", callback_data: "TIDS" },
						{ text: "6Ô∏è‚É£", callback_data: "LR" },
					],
					[
						{ text: "7Ô∏è‚É£", callback_data: "CFV" },
						{ text: "8Ô∏è‚É£", callback_data: "TD" },
						{ text: "9Ô∏è‚É£", callback_data: "VCNV" },
					],
					[{ text: "üõë Terminar", callback_data: "END" }],
				],
			},
		}
	);
});

/* ACTIONS */

// LOCAIS/POSTOS DE VACINA√á√ÉO
bot.action("LPV", (ctx) => {
	/* ctx.deleteMessage() */
	ctx.telegram.sendMessage(
		ctx.chat.id,
		`*LOCAIS E POSTOS DE VACINA√á√ÉO*

Abaixo temos o link do site oficial da secretaria de sa√∫de que disponibiliza os locais e os hor√°rios das vacinas para pessoas de todas as idades.
O site contem as primeiras doses, segundas doses, doses adicionais, doses de refor√ßo e postos noturnos. A pagina √© oficial e √© atualizada regularmente.`,
		{
			parse_mode: "Markdown",
			reply_markup: {
				inline_keyboard: [
					[
						{
							text: "‚ÜóÔ∏è Link",
							url: "https://www.saude.df.gov.br/locaisdevacinacao/",
						},
					],
					[
						{ text: "‚èèÔ∏è Inicio", callback_data: "restart" },
						{ text: "üõë Terminar", callback_data: "END" },
					],
				],
			},
		}
	);
});

// MASCARAS RECOMENDADAS
bot.action("MR", (ctx) => {
	/* ctx.deleteMessage() */
	/* ctx.telegram.sendPhoto(
		ctx.chat.id,
		"https://a-static.mlcdn.com.br/618x463/mascara-respirador-pff2-n95-similar-kn95-adulto-branca-pacote-50-unidades-exmedi/atacadonet/143p/7a1c5cafe28fe3291452e4c5a50e7c41.jpg",
		{
			caption: "M√°scaras PFF2 (ou N95)",
		}
	); */
	ctx.telegram.sendMessage(
		ctx.chat.id,
		`*M√ÅSCARAS RECOMENDADAS*
		
O guia mostra os melhores tipos e as combina√ß√µes mais eficientes, ordenadas em ordem de recomenda√ß√£o e qualidade:

1Ô∏è‚É£ - M√°scaras PFF2 (ou N95)
2Ô∏è‚É£ - M√°scaras KN95
3Ô∏è‚É£ - M√°scaras elastom√©ricas
4Ô∏è‚É£ - M√°scaras com v√°lvula
5Ô∏è‚É£ - M√°scaras cir√∫rgicas ou de procedimentos
6Ô∏è‚É£ - M√°scaras de pano com 3 camadas
(Apenas em ultimo caso de falta/emergencia)
		
Segue abaixo o link de refer√™ncia de uma mat√©ria completa sobre o assunto. ‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è`,
		{
			parse_mode: "Markdown",
			reply_markup: {
				inline_keyboard: [
					[
						{
							text: "‚ÜóÔ∏è Link",
							url: "https://g1.globo.com/bemestar/coronavirus/noticia/2021/06/11/mascaras-contra-a-covid-19-guia-mostra-os-melhores-tipos-e-as-combinacoes-mais-eficientes.ghtml",
						},
					],
					[
						{ text: "‚èèÔ∏è Inicio", callback_data: "restart" },
						{ text: "üõë Terminar", callback_data: "END" },
					],
				],
			},
		}
	);
});

// CUIDADOS
bot.action("CP", (ctx) => {
	/* ctx.deleteMessage() */
	ctx.telegram.sendMessage(
		ctx.chat.id,
		`*Cuidados e Profilaxia*

Para evitar a propaga√ß√£o da COVID-19, siga estas orienta√ß√µes:
      
‚ñ´Ô∏è Mantenha uma dist√¢ncia segura de outras pessoas, mesmo que elas n√£o pare√ßam estar doentes.
‚ñ´Ô∏è Use m√°scara em p√∫blico, especialmente em locais fechados ou quando n√£o for poss√≠vel manter o distanciamento f√≠sico.
‚ñ´Ô∏è Prefira locais abertos e bem ventilados em vez de ambientes fechados. Abra uma janela se estiver em um local fechado.
‚ñ´Ô∏è Limpe as m√£os com frequ√™ncia. Use sab√£o e √°gua ou √°lcool em gel.
‚ñ´Ô∏è Tome a vacina quando chegar a sua vez. Siga as orienta√ß√µes locais para isso.
‚ñ´Ô∏è Cubra o nariz e a boca com o bra√ßo dobrado ou um len√ßo ao tossir ou espirrar.
‚ñ´Ô∏è Fique em casa se voc√™ sentir indisposi√ß√£o.`,
		{
			parse_mode: "Markdown",
			reply_markup: {
				inline_keyboard: [
					[
						{ text: "‚èèÔ∏è Inicio", callback_data: "restart" },
						{ text: "üõë Terminar", callback_data: "END" },
					],
				],
			},
		}
	);
});

// TAXA EFICIENCIA
bot.action("TEV", (ctx) => {
	/* ctx.deleteMessage() */
	ctx.telegram.sendMessage(
		ctx.chat.id,
		`*TAXA DE EFIC√ÅCIA DAS VACINAS*

1Ô∏è‚É£ - Vacina Astrazeneca
A vacina demonstrou efic√°cia de _70,4%_ contra a infec√ß√£o e _100%_ contra casos graves da infec√ß√£o.

2Ô∏è‚É£ - Vacina Coronavac
A vacina demonstrou uma taxa de efic√°cia de _78%_ para casos leves e de _100%_ para infec√ß√µes moderadas e graves.

3Ô∏è‚É£ - Taxa de efic√°cia da Vacina Pfizer
A vacina apresentou _95%_ de efic√°cia contra infec√ß√£o e _100%_ contra casos graves da doen√ßa.`,
		{
			parse_mode: "Markdown",
			reply_markup: {
				inline_keyboard: [
					[
						{ text: "‚èèÔ∏è Inicio", callback_data: "restart" },
						{ text: "üõë Terminar", callback_data: "END" },
					],
				],
			},
		}
	);
});

// INTERVALO DOSES
bot.action("TIDS", (ctx) => {
	/* ctx.deleteMessage() */
	ctx.telegram.sendMessage(
		ctx.chat.id,
		`*TEMPO DE INTERVALO ENTRE DOSES DAS VACINAS*

1Ô∏è‚É£ - Vacina Astrazeneca
Intervalo de *8 semanas* para _segunda dose_
Intervalo de *4 meses* para _terceira dose_
		
2Ô∏è‚É£ - Vacina Coronavac
Intervalo de *2 a 4 semanas* para _segunda dose_
Intervalo de *4 meses* para _terceira dose_
		
3Ô∏è‚É£ - Vacina Pfizer
Intervalo de *8 semanas* para _segunda dose_
Intervalo de *4 meses* para _terceira dose_`,
		{
			parse_mode: "Markdown",
			reply_markup: {
				inline_keyboard: [
					[
						{
							text: "‚ÜóÔ∏è Fonte",
							url: "https://www.cnnbrasil.com.br/saude/intervalo-da-terceira-dose-sera-reduzido-de-cinco-para-quatro-meses-anuncia-queiroga/",
						},
					],
					[
						{ text: "‚èèÔ∏è Inicio", callback_data: "restart" },
						{ text: "üõë Terminar", callback_data: "END" },
					],
				],
			},
		}
	);
});

// REDIRECIONAMENTO
bot.action("LR", (ctx) => {
	/* ctx.deleteMessage() */
	ctx.telegram.sendMessage(
		ctx.chat.id,
		`*LINKS DE REDIRECIONAMENTO*

1Ô∏è‚É£ - Cadastro de comorbidades e grupos priorit√°rios

2Ô∏è‚É£ - Fazer agendamento

3Ô∏è‚É£ - Consultar agendamento		

4Ô∏è‚É£ - Imprimir ficha de vacina`,
		{
			parse_mode: "Markdown",
			reply_markup: {
				inline_keyboard: [
					[
						{
							text: "1Ô∏è‚É£",
							url: "https://vacina.saude.df.gov.br/Comorbidade",
						},
						{
							text: "2Ô∏è‚É£",
							url: "https://vacina.saude.df.gov.br/",
						},
						{
							text: "3Ô∏è‚É£",
							url: "https://vacina.saude.df.gov.br/Home/Consultar",
						},
						{
							text: "4Ô∏è‚É£",
							url: "https://vacina.saude.df.gov.br/Home/Ficha",
						},
					],
					[
						{ text: "‚èèÔ∏è Inicio", callback_data: "restart" },
						{ text: "üõë Terminar", callback_data: "END" },
					],
				],
			},
		}
	);
});

// COMO FUNCIONA A VACINA
bot.action("CFV", (ctx) => {
	/* ctx.deleteMessage() */
	ctx.telegram.sendMessage(
		ctx.chat.id,
		`*COMO A VACINA FUNCIONA*

Tecnologia gen√©tica do RNA mensageiro (Pfizer e Moderna): √© a tecnologia mais utilizada na produ√ß√£o de vacinas para animais e que faz com que as c√©lulas saud√°veis do corpo produzam a mesma prote√≠na que o coronav√≠rus utiliza para entrar nas c√©lulas. Ao fazer isso, o sistema imune √© obrigado a produzir anticorpos que, durante uma infec√ß√£o, podem neutralizar a prote√≠na do verdadeiro coronav√≠rus e impedir o desenvolvimento da infec√ß√£o;

Uso de adenov√≠rus modificados (Astrazeneca, Sputnik V e J&J): consiste em utilizar adenov√≠rus, que s√£o inofensivos para o corpo humano, e modific√°-los geneticamente para que atuem de forma parecida com o coronav√≠rus, mas sem risco para a sa√∫de. Isso faz com que o sistema imunol√≥gico treine e produza anticorpos capazes de eliminar o v√≠rus caso aconte√ßa a infec√ß√£o;
		
Uso do coronav√≠rus inativado (Coronavac) : √© utilizada uma forma inativada do novo coronav√≠rus que n√£o provoca a infec√ß√£o, nem problemas para a sa√∫de, mas que permite ao corpo produzir os anticorpos necess√°rios para combater o v√≠rus.
`,
		{
			parse_mode: "Markdown",
			reply_markup: {
				inline_keyboard: [
					[
						{
							text: "‚ÜóÔ∏è Fonte",
							url: "https://www.tuasaude.com/vacina-covid/",
						},
					],
					[
						{ text: "‚èèÔ∏è Inicio", callback_data: "restart" },
						{ text: "üõë Terminar", callback_data: "END" },
					],
				],
			},
		}
	);
});

// TERCEIRA DOSE
bot.action("TD", (ctx) => {
	/* ctx.deleteMessage() */
	ctx.telegram.sendMessage(
		ctx.chat.id,
		`*√â PRECISO TOMAR A TERCEIRA DOSE?*

O Minist√©rio da Sa√∫de no Brasil autorizou a terceira dose da vacina contra a COVID-19, com previs√£o de iniciar a aplica√ß√£o em setembro, preferencialmente com uma dose de refor√ßo da vacina da Pfizer ou, de forma alternativa, uma dose de uma das vacinas da AstraZeneca ou da Janssen.

Essa dose de refor√ßo, inicialmente ser√° feita em idosos com mais de 60 anos que tenham recebido as duas doses de qualquer outra vacina da COVID-19 h√° pelo menos 6 meses e, tamb√©m, para pessoas com o sistema imunol√≥gico enfraquecido que completaram o esquema de vacina√ß√£o com duas doses de qualquer vacina ou dose √∫nica da Janssen h√° pelo menos 28 dias e para os profissionais de sa√∫de. Veja quando tomar a terceira dose da vacina contra a COVID-19. üß≠
		
Em Portugal, a Ag√™ncia Europeia de Medicamentos autorizou a aplica√ß√£o da terceira dose da vacina contra a COVID-19 com Pfizer para pessoas acima dos 65 anos e que foram vacinadas com esse imunizante.
`,
		{
			parse_mode: "Markdown",
			reply_markup: {
				inline_keyboard: [
					[
						{ text: "üß≠ Intervalo Doses", callback_data: "TIDS" },
						{
							text: "‚ÜóÔ∏è Fonte",
							url: "https://www.tuasaude.com/vacina-covid/",
						},
					],
					[
						{ text: "‚èèÔ∏è Inicio", callback_data: "restart" },
						{ text: "üõë Terminar", callback_data: "END" },
					],
				],
			},
		}
	);
});

// TERCEIRA DOSE
bot.action("VCNV", (ctx) => {
	/* ctx.deleteMessage() */
	ctx.telegram.sendMessage(
		ctx.chat.id,
		`*A VACINA CONTRA AS NOVAS VARIANTES*

De acordo com a OMS, as vacinas contra a COVID-19 dever√£o apresentar efeito contra as variantes do v√≠rus que forem surgindo, j√° que estimulam uma complexa resposta imune de todo o organismo, que ficar√° "atento" para part√≠culas do novo coronav√≠rus, mesmo que surjam algumas modifica√ß√µes na sua estrutura.

Ainda assim, mesmo que se fique infectado com uma nova variante, as chances de desenvolver uma infec√ß√£o grave que coloque a vida em risco, √© muito inferior para quem se encontra completamente imunizado, ou seja, com mais de 2 semanas ap√≥s a 2¬™ dose da vacina.
		
√â esperado que, ao longo do tempo e, √† medida que v√£o surgindo novas variantes, que a composi√ß√£o das vacinas seja gradualmente atualizada, para conferir maior prote√ß√£o.
`,
		{
			parse_mode: "Markdown",
			reply_markup: {
				inline_keyboard: [
					[
						{
							text: "‚ÜóÔ∏è Fonte",
							url: "https://www.tuasaude.com/vacina-covid/",
						},
					],
					[
						{ text: "‚èèÔ∏è Inicio", callback_data: "restart" },
						{ text: "üõë Terminar", callback_data: "END" },
					],
				],
			},
		}
	);
});

// END
bot.action("END", (ctx) => {
	ctx.deleteMessage();
	bot.stop();
});

/* ACTION DEFAULT */
// 1Ô∏è‚É£2Ô∏è‚É£3Ô∏è‚É£4Ô∏è‚É£5Ô∏è‚É£6Ô∏è‚É£7Ô∏è‚É£8Ô∏è‚É£9Ô∏è‚É£üîü‚ÜóÔ∏è
bot.action("CP", (ctx) => {
	/* ctx.deleteMessage() */
	ctx.telegram.sendMessage(ctx.chat.id, ``, {
		parse_mode: "Markdown",
		reply_markup: {
			inline_keyboard: [[{ text: "", callback_data: "" }]],
		},
	});
});

/* HELP */
bot.help((ctx) =>
	ctx.reply(
		`Fant√°stico!üëè Aqui abaixo est√° a descri√ß√£o das minhas funcionalidades, por favor üôè leia antes de prosseguir pra voc√™ desfrutar de tudo que esse bot pode oferecer.
		
Aqui est√° a lista dos meus principais recursos:
‚ñ´Ô∏è Locais Postos de vacina√ß√£o
‚ñ´Ô∏è Pontos de vacina√ß√£o para primeira dose, segunda dose, dose de refor√ßo e para 85+
‚ñ´Ô∏è M√°scaras Recomendadas
‚ñ´Ô∏è Cuidados e Profilaxia 
‚ñ´Ô∏è Taxa de efic√°cia das vacinas
‚ñ´Ô∏è Tempo de intervalo das doses
‚ñ´Ô∏è Link de redirecionamento (agendamento,cadastro,consulta e imprimir)
‚ñ´Ô∏è Mais informa√ß√µes da vacina 

E aqui est√° a lista completa de comandos:
/start - comece a usar bot / v√° para o menu principal
/help - ajuda aberta
/add - adicionar novo lembrete
/list - obter uma lista de seus lembretes
/citacao - cita√ß√£o do dia
/settings - alterar as configura√ß√µes do bot 
/web - gera link para a interface da Web do bot
/cancel - cancela a opera√ß√£o atual

Se voc√™ gosta ‚ù§Ô∏è de como fa√ßo meu trabalho, n√£o se esque√ßa de dar +rep no github do projeto: https://github.com/usbangelo/covid19-telegramBot-nodejs
Isso √© muito importante para mim. Obrigado!

Isso √© tudo. Podemos come√ßar? Do que devo lembr√°-lo?`
	)
);

/* FUNCTIONS */
// ACTUAL USE
/* 
statecode = ctx.match
getData()
.then((result)=>{
	ctx.telegram.sendMessage(ctx.chat.id, result,{
		reply_markup: {
				inline_keyboard: [
					[
						{ text: "‚èèÔ∏è Inicio", callback_data: "restart" },
						{ text: "üõë Terminar", callback_data: "END" },
					],
				],
			},
	})
})*/

async function getData(statecode) {
	url = "https://api.covid19india.org/data.json";
	let res = await axios.get(url);
	estadoDataArr = res.data.statewise;
	dataEstado = estadoDataArr.filter((elem) => {
		return elem.statecode == statecode;
	});
	cases = dataEstado[0];
	/* console.log(cases.confirmed); */
	results = `Casos em ${cases.state}
Casos confirmados: ${cases.confirmed}
Casos ativos: ${cases.active}
Casos recuperados: ${cases.recovered}
Mortes confirmadas: ${cases.deaths}
		`;
	return results;
}

/* COMMANDS */
bot.command("citacao", (ctx) => {
	url = "http://yerkee.com/api/fortune";

	axios.get(url).then((res) => {
		console.log(res.data.fortune);
		ctx.reply(res.data.fortune);
	});
});

bot.on("sticker", (ctx) => ctx.reply("ü¶†"));
bot.hears("hi", (ctx) => ctx.reply("Hey there"));

// MAIN FUNCTIONS
//bot.launch()
module.exports = bot;

// Permite parar execucao graciosamente
process.once("SIGINT", () => bot.stop("SIGINT"));
process.once("SIGTERM", () => bot.stop("SIGTERM"));
